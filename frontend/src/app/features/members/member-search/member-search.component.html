<div class="container">
  <mat-card>
    <mat-card-header>
      <mat-card-title>Member Search</mat-card-title>
    </mat-card-header>

    <mat-card-content>
      <div class="search-section">
        <mat-form-field appearance="outline" class="search-field">
          <mat-label>Search members</mat-label>
          <input
            matInput
            [formControl]="searchControl"
            placeholder="Member #, name, email, or phone"
          />
          <mat-icon matPrefix>search</mat-icon>
          @if (searchControl.value) {
            <button
              mat-icon-button
              matSuffix
              (click)="searchControl.setValue('')"
              aria-label="Clear search"
            >
              <mat-icon>close</mat-icon>
            </button>
          }
        </mat-form-field>

        <div class="filter-chips">
          <mat-chip-listbox aria-label="Status filter" [multiple]="false">
            <mat-chip-option
              [selected]="selectedStatus === null"
              (click)="filterByStatus(null)"
            >
              All
            </mat-chip-option>
            <mat-chip-option
              [selected]="selectedStatus === 'Active'"
              (click)="filterByStatus('Active')"
            >
              Active
            </mat-chip-option>
            <mat-chip-option
              [selected]="selectedStatus === 'Locked'"
              (click)="filterByStatus('Locked')"
            >
              Locked
            </mat-chip-option>
            <mat-chip-option
              [selected]="selectedStatus === 'Closed'"
              (click)="filterByStatus('Closed')"
            >
              Closed
            </mat-chip-option>
          </mat-chip-listbox>

          @if (searchControl.value || selectedStatus) {
            <button mat-stroked-button (click)="clearFilters()">
              <mat-icon>clear_all</mat-icon>
              Clear Filters
            </button>
          }
        </div>
      </div>

      @if (isLoading) {
        <div class="loading-spinner">
          <mat-spinner diameter="50"></mat-spinner>
          <p>Loading members...</p>
        </div>
      }

      @if (!isLoading && members.length > 0) {
        <div class="table-container">
          <table mat-table [dataSource]="members" class="members-table">
            <ng-container matColumnDef="memberNumber">
              <th mat-header-cell *matHeaderCellDef>Member #</th>
              <td mat-cell *matCellDef="let member">
                {{ member.memberNumber }}
              </td>
            </ng-container>

            <ng-container matColumnDef="name">
              <th mat-header-cell *matHeaderCellDef>Name</th>
              <td mat-cell *matCellDef="let member">
                {{ member.firstName }} {{ member.lastName }}
              </td>
            </ng-container>

            <ng-container matColumnDef="email">
              <th mat-header-cell *matHeaderCellDef>Email</th>
              <td mat-cell *matCellDef="let member">{{ member.email }}</td>
            </ng-container>

            <ng-container matColumnDef="phone">
              <th mat-header-cell *matHeaderCellDef>Phone</th>
              <td mat-cell *matCellDef="let member">{{ member.phone }}</td>
            </ng-container>

            <ng-container matColumnDef="status">
              <th mat-header-cell *matHeaderCellDef>Status</th>
              <td mat-cell *matCellDef="let member">
                <mat-chip [class]="'status-' + member.status.toLowerCase()">
                  {{ member.status }}
                </mat-chip>
              </td>
            </ng-container>

            <ng-container matColumnDef="flags">
              <th mat-header-cell *matHeaderCellDef>Flags</th>
              <td mat-cell *matCellDef="let member">
                @if (getActiveFlagCount(member) > 0) {
                  <mat-chip color="warn" highlighted>
                    <mat-icon>flag</mat-icon>
                    {{ getActiveFlagCount(member) }}
                  </mat-chip>
                }
              </td>
            </ng-container>

            <ng-container matColumnDef="joinDate">
              <th mat-header-cell *matHeaderCellDef>Join Date</th>
              <td mat-cell *matCellDef="let member">
                {{ member.joinDate | date: "shortDate" }}
              </td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
            <tr
              mat-row
              *matRowDef="let row; columns: displayedColumns"
              class="member-row"
              (click)="viewMember(row)"
            ></tr>
          </table>
        </div>
      }

      @if (!isLoading && members.length === 0) {
        <div class="no-results">
          <mat-icon>search_off</mat-icon>
          <p>No members found</p>
          @if (searchControl.value || selectedStatus) {
            <button mat-stroked-button (click)="clearFilters()">
              Clear Filters
            </button>
          }
        </div>
      }
    </mat-card-content>
  </mat-card>
</div>
